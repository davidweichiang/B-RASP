<!DOCTYPE html>
<html>

<head>
    <title>BRASP Test</title>
</head>

<body>
    <h1>BRASP Test Page</h1>
    <p>Welcome to the BRASP test page!</p>
    <script src="https://unpkg.com/mathjs@12.4.2/lib/browser/math.js" type="text/javascript"></script>
    <script src="https://unpkg.com/ohm-js@17/dist/ohm.js"></script>
    <script src="brasp.js"></script>
    <script>
        // // Create a new BRASP instance
        // const brasp = new BRASP();

        // // Add an InitailOperation to the BRASP instance
        // Q_a = new InitialOperation("a");
        // Q_b = new InitialOperation("b");
        // Q_c = new InitialOperation("c");
        // brasp.addOperation(Q_a);
        // brasp.addOperation(Q_b);
        // brasp.addOperation(Q_c);
        // P = new BooleanOperation("P", "not Q_a(i) | Q_b(i)");
        // Q = new AttentionOperation("Q", "rightmost", "j<i", "Q_a(i) | Q_b(j)", "Q_b(j)", "Q_a(i)");
        // brasp.addOperation(P);
        // brasp.addOperation(Q);
        // console.log(brasp.getOperations());
        // output = brasp.execute(["a", "b", "a", "d", "e"]);
        // console.log(output);
    </script>
    <script>
        const myGrammar = ohm.grammar(String.raw
            `BRASP{

Operation
= InitialOp
| BooleanOp
| AttentionOp

BoolExp
= AndBool
| OrBool
| NotBool
| ParenBool
| FunBool
| Top
| Bot

AndBool = BoolExp "&" BoolExp

OrBool = BoolExp "|" BoolExp

NotBool = "not" BoolExp

Top = "1"

Bot = "0"

ParenBool = "(" BoolExp ")"

FunBool
= (lower | upper | "_")+ "(i)"
| (lower | upper | "_")+ "(j)"

InitialOp = "Q_" letter "(i)"

BooleanOp = (lower | upper | "_")+ "(i)" ":=" BoolExp

AttentionOp
= (lower | upper | "_")+ "(i)" ":=" Tiebreaker "[" Mask "," Score "]" Value ":" DefaultExp

Tiebreaker
= "leftmost"
| "rightmost"

Mask
= "j<i"
| "i<j"
| "j<=i"
| "i<=j"
| "1"

Score = BoolExp

Value = BoolExp

DefaultExp
= AndBool
| OrBool
| NotBool
| ParenBool
| FunDefault
| Top
| Bot

AndDefault = DefaultExp "&" DefaultExp

OrDefault = DefaultExp "|" DefaultExp

NotDefault = "not" DefaultExp

ParenDefault = "(" DefaultExp ")"

FunDefault = (lower | upper | "_")+ "(i)"
}`
        );

        const semantics = myGrammar.createSemantics().addOperation('eval', {
            // BoolExp should just be a string

            _iter(...children) {  // Correcting the semantic action
                return children.map(child => child.eval());
            },
            _terminal() {  // Adding the semantic action for terminals
                return this.sourceString;
            },
            letter(chars) {
                return chars.eval();
            },
            lower(_) {
                return this.sourceString;
            },
            upper(_) {
                return this.sourceString;
            },
            BoolExp(exp) {
                return this.sourceString;
            },
            DefaultExp(exp) {
                return this.sourceString;
            },
            InitialOp(Q, letter, i) {
                op = new InitialOperation(letter.eval());
                return op;
            },
            BooleanOp(name, i, eq, expression) {
                console.log(name.eval().join(''));
                console.log(expression.eval());
                op = new BooleanOperation(name.eval().join(''), expression.eval());
                return op;
            },
            AttentionOp(name, i, eq, tie, lbr, mask, com, score, rbr, value, col, defaultExp) {
                console.log(name.eval().join(''));
                console.log(tie.eval());
                op = new AttentionOperation(name.eval().join(''), tie.eval(), mask.eval(), score.eval(), value.eval(), defaultExp.eval());
                return op;
            },

        });

        const userInput = "P_k(i) := leftmost [j<i, 1] Q_a(j) : Q_b(i)";
        const m = myGrammar.match(userInput);
        if (m.succeeded()) {
            console.log('Greetings, human.');
            console.log(m);
            console.log(semantics(m).eval());
        } else {
            console.log("That's not a greeting!");
        }
    </script>
</body>

</html>